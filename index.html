<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>اختبار تفاعلي</title>
<style>
    body{margin:0;font-family:sans-serif;background:#f8fafc;color:#111;user-select:none}
    .container{max-width:800px;margin:auto;padding:20px}
    h1{text-align:center;color:#1f2937;margin-bottom:20px}
    .hidden{display:none}
    .form-group{margin-bottom:12px}
    input{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
    button{padding:10px 20px;font-size:16px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer;transition:.3s}
    button:hover{background:#1d4ed8}
    .question-card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .answers{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    label{background:#f1f5f9;padding:10px;border-radius:8px;cursor:pointer;transition:.3s}
    label:hover{background:#e2e8f0}
    .timer{text-align:center;font-size:18px;margin-bottom:15px;color:#dc2626;font-weight:bold}
    .score{font-size:22px;font-weight:bold;margin-bottom:20px;text-align:center}
    @media(max-width:600px){h1{font-size:18px}.question-card{padding:12px}button{width:100%}}
</style>
</head>
<body oncontextmenu="return false;">
<div class="container">
    <h1>الاختبار</h1>

    <!-- بيانات الطالب -->
    <div id="student-form">
        <div class="form-group">
            <input type="text" id="name" placeholder="الاسم" required>
        </div>
        <div class="form-group">
            <input type="email" id="email" placeholder="البريد الإلكتروني" required>
        </div>
        <div class="form-group">
            <input type="number" id="age" placeholder="العمر" required>
        </div>
        <button onclick="startExam()">ابدأ الامتحان</button>
    </div>

    <!-- المؤقت -->
    <div class="timer hidden" id="timer"></div>

    <!-- منطقة السؤال -->
    <div id="quiz" class="hidden">
        <div class="question-card" id="question-box"></div>
        <div style="margin-top:15px;text-align:center;">
            <button onclick="nextQuestion()">التالي</button>
        </div>
    </div>

    <!-- النتيجة -->
    <div id="result" class="hidden"></div>
</div>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby4gqrjLLCgMtu6HJSCuX5mhrZNNhFJmZ5T8iX_bSYB5jQayly-bcbMXwX6RSEBUlfTeg/exec://script.google.com/macros/s/AKfycbxQOCshosZEqr687BeqFwcBN9k46ZlYUvnehfUGwl60bElFSdTEDPE3MjuwnBXnD0SntQ/exec";
const SECRET_TOKEN = "my_exam_secret_123";

let questions = [];
let currentIndex = 0;
let selectedAnswers = [];
let student = {};
let timerInterval;
let remainingTime = 5 * 60; // 5 دقائق

async function startExam(){
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim().toLowerCase();
    const age = document.getElementById('age').value.trim();

    if(!name || !email || !age){
        alert("من فضلك أدخل كل البيانات");
        return;
    }

    if(localStorage.getItem('exam_done_'+email)){
        alert("لقد أتممت الاختبار مسبقاً.");
        return;
    }

    student = {name,email,age};

    // جلب الأسئلة
    await fetch('questions.json')
        .then(res => res.json())
        .then(data => {
            questions = selectQuestions(data);
        });

    document.getElementById('student-form').classList.add('hidden');
    document.getElementById('quiz').classList.remove('hidden');
    document.getElementById('timer').classList.remove('hidden');

    showQuestion();
    startTimer();

    // عند الخروج قبل التسليم
    window.addEventListener('beforeunload', () => {
        localStorage.setItem('exam_done_'+email, '1');
    });
}

// اختيار 10 أسئلة موزعة بالتساوي
function selectQuestions(allQuestions){
    const grouped = {};
    allQuestions.forEach(q=>{
        if(!grouped[q.subject]) grouped[q.subject] = [];
        grouped[q.subject].push(q);
    });

    let result = [];
    const subjects = Object.keys(grouped);
    const perSubject = Math.floor(10 / subjects.length);

    subjects.forEach(sub=>{
        const shuffled = grouped[sub].sort(()=>Math.random()-0.5);
        result.push(...shuffled.slice(0, perSubject));
    });

    // لو نقص، نكمل عشوائي من الكل
    while(result.length < 10){
        result.push(allQuestions[Math.floor(Math.random()*allQuestions.length)]);
    }

    return result.sort(()=>Math.random()-0.5);
}

function showQuestion(){
    if(currentIndex >= questions.length){
        finishExam();
        return;
    }

    const q = questions[currentIndex];
    const box = document.getElementById('question-box');
    box.innerHTML = `<div><strong>${q.question}</strong></div>`;
    const answersDiv = document.createElement('div');
    answersDiv.className = 'answers';

    q.options.forEach((opt,i)=>{
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="answer" value="${i}"> ${opt}`;
        answersDiv.appendChild(label);
    });

    box.appendChild(answersDiv);
}

function nextQuestion(){
    const selected = document.querySelector('input[name="answer"]:checked');
    if(!selected){
        alert("يجب اختيار إجابة قبل الانتقال");
        return;
    }

    selectedAnswers.push(parseInt(selected.value));
    currentIndex++;
    showQuestion();
}

function startTimer(){
    const timerEl = document.getElementById('timer');
    timerEl.textContent = `الوقت المتبقي: ${formatTime(remainingTime)}`;

    timerInterval = setInterval(()=>{
        remainingTime--;
        timerEl.textContent = `الوقت المتبقي: ${formatTime(remainingTime)}`;
        if(remainingTime <= 0){
            clearInterval(timerInterval);
            finishExam();
        }
    },1000);
}

function formatTime(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m}:${s<10?'0'+s:s}`;
}

async function finishExam(){
    clearInterval(timerInterval);
    document.getElementById('quiz').classList.add('hidden');
    document.getElementById('timer').classList.add('hidden');

    let score = 0;
    const details = questions.map((q,i)=>{
        const chosenIndex = selectedAnswers[i] ?? -1;
        const chosen = chosenIndex >=0 ? q.options[chosenIndex] : "(لم يجب)";
        const correct = q.options[q.correct];
        const isCorrect = chosenIndex === q.correct;
        if(isCorrect) score++;
        return {index:i+1, question:q.question, chosen, correct, isCorrect};
    });

    const resultData = {score, total: questions.length, details};

    const serverResp = await sendResultsToServer(student, resultData);
    if (serverResp.ok) {
        localStorage.setItem('exam_done_' + student.email.toLowerCase(), '1');
        showResult(score, details);
    } else if (serverResp.reason === 'duplicate') {
        alert('هذا البريد مسجّل بالفعل. لا يمكنك إعادة الامتحان.');
    } else {
        alert('خطأ في إرسال النتيجة. حاول مرة أخرى.');
    }
}

async function sendResultsToServer(student, lastResults) {
  const payload = {
    token: SECRET_TOKEN,
    name: student.name,
    email: student.email,
    age: student.age,
    score: lastResults.score,
    total: lastResults.total,
    attemptId: String(Date.now()),
    details: lastResults.details
  };

  try {
    const res = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    console.log('Server response:', json);
    return json;
  } catch (err) {
    console.error('Send failed', err);
    return { ok:false, error:'network' };
  }
}

function showResult(score, details){
    const res = document.getElementById('result');
    res.classList.remove('hidden');
    let html = `<div class="score">نتيجتك: ${score} من ${questions.length}</div>`;
    details.forEach(d=>{
        html += `<div class="question-card" style="border-left:4px solid ${d.isCorrect?'#16a34a':'#ef4444'};margin-bottom:10px;">
            <div><strong>${d.index}. ${d.question}</strong></div>
            <div>إجابتك: ${d.chosen}</div>
            <div>الإجابة الصحيحة: ${d.correct}</div>
        </div>`;
    });
    res.innerHTML = html;
}

// منع الرجوع والطباعة
history.pushState(null,null,location.href);
window.onpopstate=function(){history.go(1)};
document.addEventListener('keydown', e=>{
    if(e.key==='PrintScreen' || (e.ctrlKey && e.key==='p')){
        alert('غير مسموح');
        e.preventDefault();
    }
});
</script>
</body>
</html>
